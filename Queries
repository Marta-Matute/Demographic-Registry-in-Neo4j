// 1. Dels padró de 1866 de Csatellví de Rosaures (CR), retorna el número d'habitants i la llista de noms. Elimina duplicats i nan.
match (h:HABITATGE)<-[:VIU]-(p:PERSONA) where p.Cognom <> 'nan' and h.Any_Padro = 1866 and h.Municipi = "CR" return count(p) as `Num habitants`, collect(distinct p.Cognom) as Llistat

// 2. Dels padrons de Sant Feliu de Llobregat (SFLL) d'abans de l'any 1840 (no inclòs), retorna la població, l'any del padró i la llista d'identificadors dels habitatges de cada padró. Ordena els resultats per l'any de padró.
match (h:HABITATGE)<-[:VIU]-(p:PERSONA) 
where h.Any_Padro < 1840 and h.Municipi = "SFLL"
return distinct h.Any_Padro as Any, collect(DISTINCT h.Id_Llar) as `Llista llars`
order by h.Any_Padro

// 3. Retorna el nom de les persones que vivien al mateix habitatge que "rafel marti" (no té segon cognom) segons el padró de 1838 de Sant Feliu de Llobregat (SFLL). Retorna la informació en mode graf i mode llista.
match (p:PERSONA)-[:VIU]->(h:HABITATGE)<-[:VIU]-(q:PERSONA) where p.Nom = "rafel" and p.Cognom = "marti" return p.Nom as nom, collect(q.Nom) as convivents 

// 4. Retorna totes les aparicions de "Miguel ballester". Fes servir la relació SAME_AS per poder retornar totes les instancies, independentment de si hi ha variacions lèxiques (ex. diferents formes d'escriure el seu nom/cognoms). Mostra la informació en forma de subgraf.
match (p:PERSONA)-[:SAME_AS]-(q:PERSONA) where p.Nom = "miguel" and p.Cognom = "ballester" return p,q

(CALL gds.graph.create.cypher)

// 5. Mostra totes les persones relacionades amb "antonio farran". Mostra la informació en forma de taula: el nom, cognom1, cognom2, i tipus de relació.
match (p:PERSONA)-[rel]-(q:PERSONA) where p.Nom = "antonio" and p.Cognom = "farran" return q.Nom as Nom, q.Cognom as Cognom1, q.Segon_Cognom as Cognom2, type(rel) as Tipus

// 6. Llisteu totes les relacions familiars que hi ha.
match (p:PERSONA)-[r:FAMILIA]-(q:PERSONA) where r.Relacio_Harmonitzada <> 'null' return collect(distinct r.Relacio_Harmonitzada)

// 7. Identifiqueu els nodes que representen el mateix habitatge (carrer i numero) al llarg dels anys de Sant Feliu del Llobregat (SFLL). Mostreu el resultat dels habitatges que tingueu totes dues informacions (carrer i numero), el nombre total d’habitatges, el llistat d’anys dels padrons i el llistat de les Ids de les llars. Ordeneu de més a menys segons el total d’habitatges i mostreu-ne els 10 primers.
match (h1:HABITATGE) match (h2:HABITATGE)
where h1.Carrer = h2.Carrer and h1.Numero = h2.Numero and h1.Id_Llar <> h2.Id_Llar and h1.Municipi = "SFLL" and h2.Municipi = "SFLL" 
return h1.Carrer as Carrer, h1.Numero as Numero, count(distinct h2) as Total, collect(distinct h2.Any_Padro) as any, collect(DISTINCT h2.Id_Llar) as Ids
order by Total desc limit 10

// 8. Mostreu les famílies de Castellví de Rosanes amb més de 3 fills. Mostreu el nom i cognoms del cap de família i el nombre de fills. Ordeneu-les pel nombre de fills fins a un límit de 20, de més a menys. 
match (h:HABITATGE)-[:VIU]-(p:PERSONA)-[r:FAMILIA]->(q:PERSONA) 
where r.Relacio_Harmonitzada =~ "f.*" and r.Relacio_Harmonitzada <> "familiar" and h.Municipi = "CR"
with count(distinct q) as total, p.Nom as nom, p.Cognom as `1er cognom`, p.Segon_Cognom as `2n Cognom`
where total>3
return nom, `1er cognom`,`2n Cognom`, total
order by total desc
limit 20

// Una altra manera de fer-ho, pero no dona igual que al joc de proves tot i que ara si que s'agafen a partir de 3 fills
match (h:HABITATGE)<-[:VIU]-(p:PERSONA)-[r:FAMILIA]->(q:PERSONA) 
where r.Relacio_Harmonitzada='fill' or r.Relacio_Harmonitzada='filla' and h.Municipi = 'CR'
with p,count(q.Nom) as NumFills
where NumFills>3
return p.Nom as Nom, p.Cognom as `1r Cognom`, p.Segon_Cognom as `2n Cognom`, NumFills
order by NumFills desc limit 20


// 9. Mitja de fills a Sant Feliu del Llobregat l’any 1881 per família. Mostreu el total de fills, el nombre d’habitatges i la mitja.
match (h:HABITATGE)<-[:VIU]-(p:PERSONA)-[r:FAMILIA]->(q:PERSONA)
where (r.Relacio_Harmonitzada = "fill" or r.Relacio_Harmonitzada = "filla") and p.Any = 1881 and h.Municipi = "SFLL"
with p as persones, count(distinct q) as nombre_fills
return sum(nombre_fills), avg(nombre_fills)

// He posat el nombre d'habitatges, el que no entenc és la mitja de fills
call{
    match (l:HABITATGE)
    where l.Municipi='SFLL' and l.Any_Padro=1881
    return count(l.Id_Llar) as NumLlars
}
match (h:HABITATGE)<-[:VIU]-(p:PERSONA)-[r:FAMILIA]->(q:PERSONA)
where (r.Relacio_Harmonitzada = "fill" or r.Relacio_Harmonitzada = "filla") and p.Any = 1881 and h.Municipi = "SFLL"
with p as persones, count(distinct q) as nombre_fills, NumLlars
return sum(nombre_fills), avg(nombre_fills), NumLlars

// 10. Per cada any que hi ha a la base de dades, quin és el carrer amb menys habitants de Sant Feliu de Llobregat?
MATCH (p:PERSONA)-[r:VIU]->(h:HABITATGE {Municipi: 'SFLL'})
WITH COLLECT(r.Any) AS an, p, h
UNWIND h.Carrer as st
WITH count(p) as per, an, st
ORDER BY per
RETURN an, COLLECT(st)[0], min(per)
ORDER BY an




// coses que falten: 
// de la query 4 falta mostrar la informació en forma de subgraf
// de la query 7 no dona com al joc de proves, pero a mes grups els hi dona així, és a dir que podria ser que estigui bé
// de la query 8 no surt el resultat com el joc de proves
// de la query 9 falta retornar "el nombre d'habitatges", que sincerament, no sé a que es refereix
// també de la query 9, el tema que al joc de proves surti que la mitja de fills es 217........
//query 10 no surt igual solucions

// mentre feia la query 9 vaig fer una comanda que al final no serveix per res, pero que basicament guarda el nombre de fills per familia en forma de propietat.
========== set nombre de fills ==========
match (p:PERSONA)-[r:FAMILIA]->(q:PERSONA)
where (r.Relacio_Harmonitzada = "fill" or r.Relacio_Harmonitzada = "filla")
with p as persona, count(DISTINCT q) as Nombre_fills, collect(p) as nodes
set persona.Numero_fills = Nombre_fills
=========================================








